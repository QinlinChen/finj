/* Generated by genhack.py */
#include "finj/config.h"
#include "finj/sys.h"

#include <stdarg.h>
#include <grp.h>
#include <pwd.h>
#include <dirent.h>
#include <sys/mman.h>

#include "finj/core.h"
#include "finj/utils.h"

int finj_open(const char *file, const char *caller, int line, const char * pathname, int flags, ...)
{
    if (checkpoint("open", file, caller, line)) {
        static int table[] = {
            EACCES, EEXIST, EFAULT, EINTR, EINVAL, EISDIR, ELOOP, ENAMETOOLONG, ENFILE, ENOENT, ENOSPC, ENOTDIR, EOVERFLOW, EPERM
        };
        errno = RAND_CHOOSE_FROM(table);
        return -1;
    }

    mode_t mode = 0;
    if (flags & O_CREAT) {
        va_list ap;
        va_start (ap, flags);
        mode = va_arg (ap, mode_t);
        va_end (ap);
    }

    return open(pathname, flags, mode);
}

int finj_openat(const char *file, const char *caller, int line, int dirfd, const char * pathname, int flags, ...)
{
    if (checkpoint("openat", file, caller, line)) {
        static int table[] = {
            EACCES, EEXIST, EFAULT, EINTR, EINVAL, EISDIR, ELOOP, ENAMETOOLONG, ENFILE, ENOENT, ENOSPC, ENOTDIR, EOVERFLOW, EPERM
        };
        errno = RAND_CHOOSE_FROM(table);
        return -1;
    }

    mode_t mode = 0;
    if (flags & O_CREAT) {
        va_list ap;
        va_start (ap, flags);
        mode = va_arg (ap, mode_t);
        va_end (ap);
    }

    return openat(dirfd, pathname, flags, mode);
}

{% for func_info in func_infos %}
{{ func_info.ret_type }} finj_{{ func_info.name }}(const char *file, const char *caller, int line{% if func_info.has_params() %}, {% endif %}{{ func_info.params_str() }})
{
    if (checkpoint("{{ func_info.name }}", file, caller, line)) {
{%- if func_info.errnos %}
        static int table[] = {
            {{ func_info.errnos_str() }}
        };
        errno = RAND_CHOOSE_FROM(table);
{%- endif %}
        return {{ func_info.ret_val }};
    }
    return {{ func_info.name }}({{ func_info.args_str() }});
}
{% endfor %}
